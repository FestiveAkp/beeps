<!DOCTYPE html>
<html>
    <head>
        <title>Smoke Detector Beeps</title>
        <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
        <style>
            @media (prefers-color-scheme: dark) {
                body {
                    background-color: #1b1b1b;
                    color: #e7e8eb;
                }
                a {
                    color: #3387cc;
                }
            }
        </style>
    </head>
    <body>
        <h1>Smoke Detector Beeps</h1>
        <div x-data>
            <div>
                <span>Smoke Detectors:</span>
                <span x-text="$store.beeps.detectors.length"></span>
                <button
                    :disabled="$store.beeps.isPlaying"
                    @click="$store.beeps.detectors.push(new Detector($store.beeps.detectors.length))"
                >
                    +
                </button>
                <button :disabled="$store.beeps.isPlaying" @click="$store.beeps.detectors.pop()">−</button>
            </div>
            <div>
                <span>Stop After:</span>
                <select x-model.number="$store.beeps.stopAfter" :disabled="$store.beeps.isPlaying">
                    <option value="never">Never</option>
                    <option value="1">1 hour</option>
                    <option value="2">2 hours</option>
                    <option value="3">3 hours</option>
                    <option value="6">6 hours</option>
                    <option value="12">12 hours</option>
                </select>
            </div>
            <div style="margin-top: 12px">
                <button x-show="!$store.beeps.isPlaying" @click="$store.beeps.startPlaying()">Start ⏵</button>
                <button x-show="$store.beeps.isPlaying" @click="$store.beeps.stopPlaying()">Stop ⏹</button>
                <button @click="playSound()">Tap ♪</button>
            </div>

            <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-top: 12px">
                <template x-for="detector in $store.beeps.detectors" :key="detector.id">
                    <div style="height: 50px; width: 50px" :style="{ backgroundColor: detector.backgroundColor }"></div>
                </template>
            </div>
        </div>
    </body>
    <script>
        const MIN_DELAY = 10000;
        const MAX_DELAY = 20000;

        class Detector {
            constructor(id = 0) {
                this.id = id;
                this.interval = null;
                this.backgroundColor = 'red';
            }
        }

        document.addEventListener('alpine:init', () => {
            Alpine.store('beeps', {
                isPlaying: false,
                detectors: [new Detector(0), new Detector(1)],
                stopAfter: 'never',
                stopAfterTimeout: null,

                startPlaying() {
                    this.isPlaying = true;

                    this.detectors.forEach((detector) => {
                        detector.interval = setRandomInterval(
                            () => {
                                const randomColor = Math.floor(Math.random() * 16777215).toString(16);
                                detector.backgroundColor = '#' + randomColor;
                                playSound();
                            },
                            MIN_DELAY,
                            MAX_DELAY
                        );
                    });

                    if (this.stopAfter !== 'never') {
                        const duration = parseInt(this.stopAfter) * 1000 * 60 * 60;
                        this.stopAfterTimeout = setTimeout(() => {
                            Alpine.store('beeps').stopPlaying();
                        }, duration);
                    }
                },

                stopPlaying() {
                    this.detectors.forEach((detector) => {
                        detector.interval.clear();
                    });
                    this.isPlaying = false;
                    clearTimeout(this.stopAfterTimeout);
                },
            });
        });

        /**
         * Run a callback at randomized intervals.
         * @see {@link https://stackoverflow.com/a/60308175}
         *
         * @param {() => void} intervalFunction
         * @param {number} minDelay
         * @param {number} maxDelay
         */
        function setRandomInterval(intervalFunction, minDelay, maxDelay) {
            let timeout;

            const runInterval = () => {
                const timeoutFunction = () => {
                    intervalFunction();
                    runInterval();
                };

                const delay = Math.floor(Math.random() * (maxDelay - minDelay + 1)) + minDelay;

                timeout = setTimeout(timeoutFunction, delay);
            };

            runInterval();

            return {
                clear() {
                    clearTimeout(timeout);
                },
            };
        }

        function playSound() {
            const audio = new Audio('./public/Beeps-filtered.mp3');
            audio.play();
        }
    </script>
</html>
